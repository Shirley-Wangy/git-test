#!/usr/bin/env groovy

def secret = """-----BEGIN PGP PRIVATE KEY BLOCK-----

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
=8OuK
-----END PGP PRIVATE KEY BLOCK-----
"""

pipeline {
    agent any

    parameters {
        booleanParam(name: 'CLEAN_WS',
            defaultValue: false,
            description: 'When checked, will clean workspace.')

        string(name: 'VERSION',
            defaultValue: '0.0.1',
            description: 'The version of the terraform provider')
    }

    stages {
        stage("clean") {
            steps {
                script {
                    if (params.CLEAN_WS) {
                        sh 'git tag -d `git tag`'
                        sh 'git reset HEAD --hard'
                        // cleanWs()
                    }
                }
            }
        }

        stage("github release") {
            environment {
                GITHUB_TOKEN = "${env.GITHUB_TOKEN}"
                GPG_PRIVATE_KEY = credentials('gpg-private-key')
                GPG_FINGERPRINT = "admin <admin@wengcx.top>"
            }
            steps {
                sh "git tag v${VERSION}"
                withGo('Go 1.18') {
                    sh """
                        test -z "$TMPDIR" && TMPDIR="$(mktemp -d)"
                        echo "$GPG_PRIVATE_KEY" > "${TMPDIR}/secret.txt"
                        gpg --import "${TMPDIR}/secret.txt"
                        rm -f "${TMPDIR}/secret.txt"
                        goreleaser release --rm-dist
                    """
                }
            }
        }
    }
}
